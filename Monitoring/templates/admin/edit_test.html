
{% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'css/construct.css' %}">
    <script async src="{% static 'js/constructor_scripts.js' %}"></script> 

{% block content %}
    <header id="page-header">
        <div class="logo">
            <img class="logo-pic" src="{% static 'image/logo.png' %}" width="100" height="100px">
            <div class="logo-text">
                <div class="up">Психологический<br> термометр<br></div>
                <div class="down">Экспресс-диагностика</div>
            </div>
        </div>
        <div class="exit">
            <a href="{% url 'user_logout' %}">
                <img src="{% static 'image/exit.png' %}" width="50" height="50">
                <div class="exit-text">
                    <span>Выйти</span>
                </div>
            </a>
        </div>
    </header>
    <div id="body-inner">
        <nav id="nav-bar">
            <a href="{% url 'admin_users' %}">Пользователи</a>
            <a href="{% url 'edit_test_list' %}">Тесты</a>
            <a href="{% url 'statistics' %}">Статистика</a>
        </nav>
        <main id="content_id">
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="window-creeate-new-test">
                    <div class="input-container">
                        <div class="window-input-name-test">
                            <div class="text-creeate-new-test">
                                <input class="date-input" type="text" name="title" value="{{ test.title }}" placeholder="Введите название теста" required>
                            </div>
                            <input class="text-input-description-test" type="text" name="description" placeholder="Введите описание теста" value="{{ test.description }}" required>
                        </div>
                    </div>
                    <button class="button-next-test-create" type="submit">Далее</button>
                </div>
                <div class="select-limit-time">
                    <div class="label">Дата и время открытия доступа к тесту:</div>
                    <input type="datetime-local" class="date-input" name="start_datetime" id="testStartDatetime" value="{{ start_datetime_formatted }}" required>
                </div>
                <div class="select-limit-time-for-test">
                    <div class="text-limit-time">Ограничение времени</div>
                    <div class="option-container1">
                        <label class="radio-option">
                            <input type="radio" name="timeLimit" value="limited" onclick="toggleLimitTime()" {% if time_limit_radio == 'limited' %}checked{% endif %}>
                            <span class="text-limit-time-2">Ограничить время тестирования</span>
                        </label>
                    </div>
                    <div class="time-inputs">
                        <div class="time-input-container">
                            <span class="text-limit-time-3">Время:</span>
                            <input type="number" name="time" min="1" value="{{ time_value }}" required>
                            <span class="text-limit-time-3">мин</span>
                        </div>
                    </div>
                    <div class="option-container2">
                        <label class="radio-option">
                            <input type="radio" name="timeLimit" value="none" onclick="toggleLimitTime()" {% if time_limit_radio == 'none' %}checked{% endif %}>
                            <span class="text-limit-time-2">Без ограничений</span>
                        </label>
                    </div>
                </div>
                <div class="select-limit-time-for-test">
                    <div class="text-limit-time-4">Назначить тест</div>
                    <div class="category-container">
                        <div class="category-options">
                            <div class="option-container1">
                                <label class="radio-option">
                                    <input type="radio" name="categorySelect" value="select" onclick="toggleCategoryFields()" {% if test.assigned_categories != 'all' %}checked{% endif %}>
                                    <span class="text-limit-time-6">Выбрать категорию</span>
                                </label>
                            </div>
                            <div class="option-container2">
                                <label class="radio-option">
                                    <input type="radio" name="categorySelect" value="assign" onclick="toggleCategoryFields()" {% if test.assigned_categories == 'all' %}checked{% endif %}>
                                    <span class="text-limit-time-6">Назначить всем</span>
                                </label>
                            </div>
                        </div>
                        <div class="category-fields" id="categoryFields" style="display: {% if test.assigned_categories == 'all' %}none{% else %}block{% endif %};">
                            <label class="checkbox-option">
                                <input type="checkbox" name="category" value="student" {% if 'student' in test.assigned_categories %}checked{% endif %}>
                                <span class="text-limit-time-6">Студент</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="category" value="staff" {% if 'staff' in test.assigned_categories %}checked{% endif %}>
                                <span class="text-limit-time-6">Сотрудник</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="category" value="guest" {% if 'guest' in test.assigned_categories %}checked{% endif %}>
                                <span class="text-limit-time-6">Гость</span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="questions-wrapper">
                    {% for question in questions %}
                    <div class="questions-container" id="questionsContainer">
                        <div class="question-form-container draggable-question" draggable="true">
                            <div class="question-form">
                                <div class="question-number">Вопрос №{{ forloop.counter }}</div>
                                <input type="hidden" name="question_id_{{ forloop.counter0 }}" value="{{ question.id }}">
                                <div class="question-header">
                                    <input class="date-input" type="text" name="question_text_{{ forloop.counter0 }}" value="{{ question.question_text }}" placeholder="Введите вопрос" required>
                                    <select class="question-type-select" name="question_type_{{ forloop.counter0 }}">
                                        <option value="choice" {% if question.question_type == 'choice' %}selected{% endif %}>Один из списка</option>
                                        <option value="scale" {% if question.question_type == 'scale' %}selected{% endif %}>Шкала</option>
                                    </select>
                                </div>
                                <label class="radio-option">
                                    <input
                                        type="checkbox"
                                        name="is_mandatory_{{ forloop.counter0 }}"
                                        {% if question.is_mandatory %}checked{% endif %}
                                    />
                                    <span class="text-limit-time-5">Обязательный вопрос</span>
                                </label>
                                {% if question.question_type == 'choice' %}
                                    <div class="question-options">
                                        <button type="button" class="add-answer-btn" onclick="addNewOption(this.closest('.question-form'))">Добавить вариант ответа</button>
                                        {% for choice in question.choices.all %}
                                        <div class="option-item">
                                            <div class="option-inputs">
                                                <input class="date-input" type="text" name="choice_text_{{ forloop.counter0 }}_{{ forloop.counter }}" value="{{ choice.choice_text }}" placeholder="Добавить вариант" required>
                                                <input class="date-input" type="number" name="score_{{ forloop.counter0 }}_{{ forloop.counter }}" value="{{ choice.score }}" placeholder="Балл" step="any" required>
                                                <span class="remove-option" onclick="removeOption(this)">×</span>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                {% elif question.question_type == 'scale' %}
                                    <div class="scale-container" style="display: flex;">
                                        <div class="scale-numbers">
                                            <input class="date-input scale-min-score" type="number" name="scale_min_score_{{ forloop.counter0 }}" value="{{ question.scales.first.min_score }}" placeholder="Минимальный балл" required>
                                            <span class="scale-divider">—</span>
                                            <input class="date-input scale-max-score" type="number" name="scale_max_score_{{ forloop.counter0 }}" value="{{ question.scales.first.max_score }}" placeholder="Максимальный балл" required>
                                        </div>
                                        <div class="scale-labels">
                                            <input class="date-input" type="text" name="scale_min_sign_{{ forloop.counter0 }}" value="{{ question.scales.first.min_sign }}" placeholder="Минимальная подпись" required>
                                            <input class="date-input" type="text" name="scale_max_sign_{{ forloop.counter0 }}" value="{{ question.scales.first.max_sign }}" placeholder="Максимальная подпись" required>
                                        </div>
                                        <div class="scale-type-container">
                                            <div class="scale-type-container-1">
                                                <select class="scale-type-select" name="scale_type_{{ forloop.counter0 }}" {% if not question.scales.first.min_score or not question.scales.first.max_score %}disabled{% endif %}>
                                                    <option value="default" {% if question.scales.first.type == 'default' %}selected{% endif %}>Стандартная шкала</option>
                                                    <option value="twoside" {% if question.scales.first.type == 'twoside' %}selected{% endif %}>Двусторонняя шкала</option>
                                                    <option value="minus" {% if question.scales.first.type == 'minus' %}selected{% endif %}>Отрицательная шкала</option>
                                                </select>
                                                <div class="scale-info-container">
                                                    <span class="scale-info-icon">?</span>
                                                    <div class="scale-info-popup">
                                                        Пример промежутка от 1 до 7:

                                                        <p class="red-text">Стандартная шкала:</p>
                                                        Отображение кнопок: 1 2 3 4 5 6 7
                                                        <br>Баллы: 1 2 3 4 5 6 7
                                                        <br>Инвертация отображение: 7 6 5 4 3 2 1
                                                        <br>Инвертация баллы: 7 6 5 4 3 2 1

                                                        <p class="red-text">Двустороння шкала:</p>
                                                        Отображение кнопок: 3 2 1 0 1 2 3
                                                        <br>Баллы: 1 2 3 4 5 6 7
                                                        <br>Инвертация отображение: 3 2 1 0 1 2 3
                                                        <br>Инвертация баллы: 7 6 5 4 3 2 1

                                                        <p class="red-text">Отрицательная шкала:</p>
                                                        Отображение кнопок: -3 -2 -1 0 1 2 3
                                                        <br>Баллы: -3 -2 -1 0 1 2 3
                                                        <br>Инвертация отображения и баллов не работает.
                                                    </div>
                                                </div>
                                            </div>
                                            <label>
                                                <input type="checkbox" class="scale-inverse-checkbox" name="scale_inverse_{{ forloop.counter0 }}" {% if question.scales.first.inverse %}checked{% endif %}>
                                                <span class="scale-inverse">Инвертировать шкалу</span>
                                            </label>
                                        </div>
                                    </div>
                                {% endif %}
                                <div class="question-actions">
                                    <button type="button" class="copy-delete-btn" onclick="copyQuestionForm(this.closest('.question-form-container'))">Копировать</button>
                                    <button type="button" class="copy-delete-btn" onclick="deleteQuestion(this.closest('.question-form-container'))">Удалить</button>
                                </div>
                            </div>
                            <button type="button" class="add-question-btn" onclick="addQuestion()">+</button>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </form>
        </main>
    </div>

    <script>
        function toggleCategoryFields() {
            const assignRadio = document.querySelector('input[name="categorySelect"][value="assign"]');
            const categoryFields = document.getElementById('categoryFields');
            if (assignRadio.checked) {
                categoryFields.style.display = 'none';
            } else {
                categoryFields.style.display = 'block';
            }
        }
        function initScaleInfoPopups() {
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.scale-info-container')) {
                    document.querySelectorAll('.scale-info-popup').forEach(popup => {
                        popup.classList.remove('show');
                    });
                }
            });
            document.querySelectorAll('.scale-info-icon').forEach(icon => {
                icon.removeEventListener('click', handleIconClick);
                icon.addEventListener('click', handleIconClick);
            });
        }
        // Обработчик клика по иконке вопроса
        function handleIconClick(e) {
            e.stopPropagation();
            const popup = this.nextElementSibling;
            const isVisible = popup.classList.contains('show');
            document.querySelectorAll('.scale-info-popup').forEach(p => {
                if (p !== popup) p.classList.remove('show');
            });
            popup.classList.toggle('show');
        }

        document.addEventListener('DOMContentLoaded', function() {
            initScaleInfoPopups();
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.addedNodes.length) {
                        initScaleInfoPopups();
                    }
                });
            });
            observer.observe(document.getElementById('questionsContainer'), {
                childList: true,
                subtree: true
            });
        });

        function bindScaleInputs(form) {
            const scaleContainer = form.querySelector('.scale-container');
            if (!scaleContainer) return;
            const minScoreInput = scaleContainer.querySelector('.scale-min-score');
            const maxScoreInput = scaleContainer.querySelector('.scale-max-score');
            const select = scaleContainer.querySelector('.scale-type-select');
            select.disabled = false; 
            minScoreInput.addEventListener('input', () => {
            });
            maxScoreInput.addEventListener('input', () => {
            });
        }

        // Функция для копирования блока вопроса
        function copyQuestionForm(container) {
            const questionsContainer = document.getElementById('questionsContainer');
            const questionIndex = questionsContainer.children.length;
            const questionText = container.querySelector('input[name^="question_text"]').value;
            const questionTypeValue = container.querySelector('select[name^="question_type"]').value;
            const scaleMinScoreInput = container.querySelector('input[name^="scale_min_score"]');
            const scaleMaxScoreInput = container.querySelector('input[name^="scale_max_score"]');
            const scaleMinSignInput = container.querySelector('input[name^="scale_min_sign"]');
            const scaleMaxSignInput = container.querySelector('input[name^="scale_max_sign"]');
            const scaleMinScore = scaleMinScoreInput ? scaleMinScoreInput.value : '';
            const scaleMaxScore = scaleMaxScoreInput ? scaleMaxScoreInput.value : '';
            const scaleMinSign = scaleMinSignInput ? scaleMinSignInput.value : '';
            const scaleMaxSign = scaleMaxSignInput ? scaleMaxSignInput.value : '';
            const scaleTypeSelect = container.querySelector('.scale-type-select');
            let scaleTypeValue = 'default';
            if (scaleTypeSelect) {
                scaleTypeValue = scaleTypeSelect.value || 'default';
            }
            const isMandatoryCheckbox = container.querySelector('input[type="checkbox"][name^="is_mandatory_"]');
            const isMandatoryChecked = isMandatoryCheckbox ? isMandatoryCheckbox.checked : false;
            const checkedAttr = isMandatoryChecked ? 'checked' : '';
            const scaleInverseCheckbox = container.querySelector('.scale-inverse-checkbox');
            const scaleInverseChecked = scaleInverseCheckbox ? scaleInverseCheckbox.checked : false;
            const scaleInverseAttr = scaleInverseChecked ? 'checked' : '';
            const newQuestionContainer = document.createElement('div');
            newQuestionContainer.className = 'question-form-container draggable-question';
            newQuestionContainer.setAttribute('draggable', 'true');
            newQuestionContainer.innerHTML = `
                <div class="question-form">
                    <div class="question-number">Вопрос</div>
                    <div class="question-header">
                        <input class="date-input" type="text" name="question_text_${questionIndex}" placeholder="Введите вопрос" required value="${questionText}">
                        <select class="question-type-select" name="question_type_${questionIndex}">
                            <option value="choice" ${questionTypeValue === 'choice' ? 'selected' : ''}>Один из списка</option>
                            <option value="scale" ${questionTypeValue === 'scale' ? 'selected' : ''}>Шкала</option>
                        </select>
                    </div>
                    <label class="radio-option">
                        <input type="checkbox" name="is_mandatory_${questionIndex}" ${checkedAttr} />
                        <span class="text-limit-time-5">Обязательный вопрос</span>
                    </label>
                    <div class="question-options" style="display: ${questionTypeValue === 'choice' ? 'block' : 'none'};"></div>
                    <div class="scale-container" style="display: ${questionTypeValue === 'scale' ? 'flex' : 'none'};">
                        <div class="scale-numbers">
                            <input class="date-input scale-min-score" type="number" placeholder="0" min="0" name="scale_min_score_${questionIndex}" value="${scaleMinScore}">
                            <span class="scale-divider">—</span>
                            <input class="date-input scale-max-score" type="number" placeholder="—" name="scale_max_score_${questionIndex}" value="${scaleMaxScore}">
                        </div>
                        <div class="scale-labels">
                            <input type="text" class="date-input" placeholder="Минимальная подпись" name="scale_min_sign_${questionIndex}" value="${scaleMinSign}">
                            <input type="text" class="date-input" placeholder="Максимальная подпись" name="scale_max_sign_${questionIndex}" value="${scaleMaxSign}">
                        </div>
                        <div class="scale-type-container">
                            <div class="scale-type-container-1">
                                <select class="scale-type-select" name="scale_type_${questionIndex}" ${(scaleMinScore && scaleMaxScore) ? '' : 'disabled'}>
                                    <option value="default" ${scaleTypeValue === 'default' ? 'selected' : ''}>Стандартная шкала</option>
                                    <option value="twoside" ${scaleTypeValue === 'twoside' ? 'selected' : ''}>Двусторонняя шкала</option>
                                    <option value="minus" ${scaleTypeValue === 'minus' ? 'selected' : ''}>Отрицательная шкала</option>
                                </select>
                                <div class="scale-info-container">
                                    <span class="scale-info-icon">?</span>
                                    <div class="scale-info-popup">
                                        Пример промежутка от 1 до 7:

                                        <p class="red-text">Стандартная шкала:</p>
                                        Отображение кнопок: 1 2 3 4 5 6 7
                                        <br>Баллы: 1 2 3 4 5 6 7
                                        <br>Инвертация отображение: 7 6 5 4 3 2 1
                                        <br>Инвертация баллы: 7 6 5 4 3 2 1

                                        <p class="red-text">Двустороння шкала:</p>
                                        Отображение кнопок: 3 2 1 0 1 2 3
                                        <br>Баллы: 1 2 3 4 5 6 7
                                        <br>Инвертация отображение: 3 2 1 0 1 2 3
                                        <br>Инвертация баллы: 7 6 5 4 3 2 1

                                        <p class="red-text">Отрицательная шкала:</p>
                                        Отображение кнопок: -3 -2 -1 0 1 2 3
                                        <br>Баллы: -3 -2 -1 0 1 2 3
                                        <br>Инвертация отображения и баллов не работает.
                                    </div>
                                </div>
                            </div>
                            <label>
                                <input type="checkbox" class="scale-inverse-checkbox" name="scale_inverse_${questionIndex}" ${scaleInverseAttr}>
                                <span class="scale-inverse">Инвертировать шкалу</span>
                            </label>
                        </div>
                    </div>
                    <div class="question-actions">
                        <button type="button" class="copy-delete-btn" onclick="copyQuestionForm(this.closest('.question-form-container'))">Копировать</button>
                        <button type="button" class="copy-delete-btn" onclick="deleteQuestion(this.closest('.question-form-container'))">Удалить</button>
                    </div>
                    <button type="button" class="add-question-btn" onclick="addQuestion()">+</button>
                </div>
            `;
            if (questionTypeValue === 'choice') {
                const optionsContainer = newQuestionContainer.querySelector('.question-options');
                const originalOptions = container.querySelectorAll('.option-item');
                originalOptions.forEach((option, oIndex) => {
                    const choiceText = option.querySelector('input[type="text"]').value;
                    const scoreValue = option.querySelector('input[type="number"]').value;
                    const newOption = document.createElement('div');
                    newOption.className = 'option-item';
                    newOption.innerHTML = `
                        <div class="option-inputs">
                            <input type="text" class="date-input" placeholder="Добавить вариант" name="choice_text_${questionIndex}_${oIndex}" value="${choiceText}">
                            <input type="number" class="date-input" placeholder="Балл" name="score_${questionIndex}_${oIndex}" value="${scoreValue}" step="any">
                            <span class="remove-option" onclick="removeOption(this)">×</span>
                        </div>
                    `;
                    newOption.querySelector('.remove-option').addEventListener('click', () => {
                        newOption.remove();
                        renameQuestionFields();
                    });
                    optionsContainer.appendChild(newOption);
                });
            }

            // Кнопка добавления вариантов остается в контейнере
            const addAnswerBtn = document.createElement('button');
            addAnswerBtn.type = 'button';
            addAnswerBtn.className = 'add-answer-btn';
            addAnswerBtn.textContent = 'Добавить вариант ответа';
            addAnswerBtn.onclick = function () {
                addNewOption(this.closest('.question-form'));
            };
            newQuestionContainer.querySelector('.question-options').prepend(addAnswerBtn);
            questionsContainer.appendChild(newQuestionContainer);
            const newCheckbox = newQuestionContainer.querySelector('.scale-inverse-checkbox');
            if (newCheckbox) {
                newCheckbox.checked = scaleInverseChecked;
            }
            const form = newQuestionContainer.querySelector('.question-form');
            initDragAndDrop();
            renameQuestionFields();
            initScaleInfoPopups();
            initQuestionForm(form);
            updateRequiredFields(form);
            if (questionTypeValue === 'scale') {
                form.querySelector('.scale-container').style.display = 'flex';
                form.querySelector('.question-options').style.display = 'none';
                bindScaleInputs(form);
            } else {
                form.querySelector('.scale-container').style.display = 'none';
                form.querySelector('.question-options').style.display = 'block';
            }
            makeQuestionsDraggable();
        }
        function makeQuestionsDraggable() {
            document.querySelectorAll('.question-form-container').forEach((el, idx) => {
                el.setAttribute('draggable', 'true');
                el.classList.add('draggable-question');
                el.dataset.index = idx;
            });
        }

        let questionCounter = 0;
        function addQuestion() {
            const questionsContainer = document.getElementById('questionsContainer');
            const questionIndex = document.querySelectorAll('.question-form-container').length;
            const newQuestionHTML = `
                <div class="question-form-container draggable-question" draggable="true">
                    <div class="question-form">
                        <div class="question-number">Вопрос</div>
                        <div class="question-header">
                            <input class="date-input" type="text" name="question_text" placeholder="Введите вопрос" required>
                            <select class="question-type-select" name="question_type">
                                <option value="choice">Один из списка</option>
                                <option value="scale">Шкала</option>
                            </select>
                        </div>
                        <label class="radio-option">
                            <input type="checkbox" name="is_mandatory_${questionIndex}" checked />
                            <span class="text-limit-time-5">Обязательный вопрос</span>
                        </label>
                        <div class="question-options">
                            <button type="button" class="add-answer-btn" onclick="addNewOption(this.closest('.question-form'))">Добавить вариант ответа</button>
                        </div>
                        <div class="scale-container" style="display: none;">
                            <div class="scale-numbers">
                                <input class="date-input scale-min-score" type="number" placeholder="0" min="0" name="scale_min_score_${questionIndex}" required>
                                <span class="scale-divider">—</span>
                                <input class="date-input scale-max-score" type="number" placeholder="—" name="scale_max_score_${questionIndex}" required>
                            </div>
                            <div class="scale-labels">
                                <input class="date-input" type="text" placeholder="Минимальная подпись" name="scale_min_sign_${questionIndex}" required>
                                <input class="date-input" type="text" placeholder="Максимальная подпись" name="scale_max_sign_${questionIndex}" required>
                            </div>
                            <div class="scale-type-container">
                                <div class="scale-type-container-1">
                                    <select class="scale-type-select" name="scale_type_${questionIndex}" disabled>
                                        <option value="default">Стандартная шкала</option>
                                        <option value="twoside">Двусторонняя шкала</option>
                                        <option value="minus">Отрицательная шкала</option>
                                    </select>
                                    <div class="scale-info-container">
                                        <span class="scale-info-icon">?</span>
                                        <div class="scale-info-popup">
                                            Пример промежутка от 1 до 7:

                                            <p class="red-text">Стандартная шкала:</p>
                                            Отображение кнопок: 1 2 3 4 5 6 7
                                            <br>Баллы: 1 2 3 4 5 6 7
                                            <br>Инвертация отображение: 7 6 5 4 3 2 1
                                            <br>Инвертация баллы: 7 6 5 4 3 2 1

                                            <p class="red-text">Двустороння шкала:</p>
                                            Отображение кнопок: 3 2 1 0 1 2 3
                                            <br>Баллы: 1 2 3 4 5 6 7
                                            <br>Инвертация отображение: 3 2 1 0 1 2 3
                                            <br>Инвертация баллы: 7 6 5 4 3 2 1

                                            <p class="red-text">Отрицательная шкала:</p>
                                            Отображение кнопок: -3 -2 -1 0 1 2 3
                                            <br>Баллы: -3 -2 -1 0 1 2 3
                                            <br>Инвертация отображения и баллов не работает.
                                        </div>
                                    </div>
                                </div>
                                <label>
                                    <input type="checkbox" class="scale-inverse-checkbox" name="scale_inverse_${questionIndex}">
                                    <span class="scale-inverse">Инвертировать шкалу</span>
                                </label>
                            </div>
                        </div>
                        <div class="question-actions">
                            <button type="button" class="copy-delete-btn" onclick="copyQuestionForm(this.closest('.question-form-container'))">Копировать</button>
                            <button type="button" class="copy-delete-btn" onclick="deleteQuestion(this.closest('.question-form-container'))">Удалить</button>
                        </div>
                    </div>
                    <button type="button" class="add-question-btn" onclick="addQuestion()">+</button>
                </div>`;
            questionsContainer.insertAdjacentHTML('beforeend', newQuestionHTML);
            const thisFormContainer = questionsContainer.lastElementChild;
            const thisForm = questionsContainer.lastElementChild.querySelector('.question-form');
            addNewOption(thisForm);
            renameQuestionFields();
            bindScaleInputs(thisForm);
            initScaleInfoPopups();
            initDragAndDrop();
            initQuestionForm(thisForm);
            updateRequiredFields(thisForm);
            const newCheckbox = thisFormContainer.querySelector('.scale-inverse-checkbox');
            if (newCheckbox) {
                newCheckbox.checked = false;
            }
        }

        function initDragAndDrop() {
            const container = document.getElementById('questionsContainer');
            let draggedElem = null;
            container.querySelectorAll('.question-form-container').forEach(block => {
                block.setAttribute('draggable', 'true');
                block.addEventListener('dragstart', function(e) {
                    draggedElem = block;
                    block.classList.add('dragging');
                });
                block.addEventListener('dragend', function(e) {
                    block.classList.remove('dragging');
                    draggedElem = null;
                });
                block.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    if (!draggedElem || block === draggedElem) return;
                    block.classList.add('drag-over');
                });
                block.addEventListener('dragleave', function(e) {
                    block.classList.remove('drag-over');
                });
                block.addEventListener('drop', function(e) {
                    e.preventDefault();
                    block.classList.remove('drag-over');
                    if (!draggedElem || block === draggedElem) return;
                    const bounding = block.getBoundingClientRect();
                    const offset = e.clientY - bounding.top;
                    if (offset < bounding.height / 2) {
                        container.insertBefore(draggedElem, block);
                    } else {
                        if (block.nextSibling) {
                            container.insertBefore(draggedElem, block.nextSibling);
                        } else {
                            container.appendChild(draggedElem);
                        }
                    }
                    renameQuestionFields();
                });
            });
        }
        document.addEventListener('DOMContentLoaded', initDragAndDrop);
        function reinitAll() {
            initDragAndDrop();
        }
        document.addEventListener('DOMContentLoaded', function() {
            initDragAndDrop();
        });

        function addNewOption(form) {
            const questionOptions = form.querySelector('.question-options');
            const questionIndex = Array.from(document.querySelectorAll('.question-form-container')).indexOf(form.closest('.question-form-container'));
            const optionIndex = questionOptions.querySelectorAll('.option-item').length;
            const newOption = document.createElement('div');
            newOption.className = 'option-item';
            newOption.innerHTML = `
                <div class="option-inputs">
                    <input class="date-input" type="text" placeholder="Добавить вариант" name="choice_text_${questionIndex}_${optionIndex}">
                    <input class="date-input" type="number" placeholder="Балл" name="score_${questionIndex}_${optionIndex}" step="any">
                    <span class="remove-option" onclick="removeOption(this)">×</span>
                </div>`;
            newOption.querySelector('.remove-option').addEventListener('click', function() {
                if (questionOptions.querySelectorAll('.option-item').length > 1) {
                    newOption.remove();
                    renameQuestionFields();
                }
            });
            questionOptions.appendChild(newOption);
            renameQuestionFields();
            updateRequiredFields(form);
            initDragAndDrop();
        }
        // Функция для удаления вопроса
        function deleteQuestion(container) {
            const questions = document.querySelectorAll('.question-form-container');
            const isFirstQuestion = questions[0] === container;
            if (isFirstQuestion) {
                alert('Первый вопрос нельзя удалить');
                return;
            }
            container.remove();
            renameQuestionFields();
        }
        
        function updateDeleteButtons() {
            document.querySelectorAll('.question-actions button:last-child').forEach(btn => {
                const container = btn.closest('.question-form-container');
                const isFirstQuestion = document.querySelector('.question-form-container') === container;
                
                if (isFirstQuestion) {
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                    btn.style.cursor = 'not-allowed';
                } else {
                    btn.disabled = false;
                    btn.style.opacity = '';
                    btn.style.cursor = '';
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            updateDeleteButtons();
        });
        const observer = new MutationObserver(function() {
            updateDeleteButtons();
        });
        observer.observe(document.getElementById('questionsContainer'), {
            childList: true,
            subtree: true
        });

        function updateQuestionNumbers() {
            const questionContainers = document.querySelectorAll('.question-form-container');
            questionContainers.forEach((container, idx) => {
                let numberDiv = container.querySelector('.question-number');
                if (!numberDiv) {
                    numberDiv = document.createElement('div');
                    numberDiv.className = 'question-number';
                    container.insertBefore(numberDiv, container.firstChild);
                }
                numberDiv.textContent = `Вопрос №${idx + 1}`;
            });
        }
        document.addEventListener('DOMContentLoaded', function () {
            const firstForm = document.querySelector('.question-form');
            if (firstForm) {
                renameQuestionFields();
                if (firstForm.querySelectorAll('.option-item').length < 1) {
                    addNewOption(firstForm);
                }
                updateRequiredFields(firstForm);
                initQuestionForm(firstForm);
            }
            document.querySelectorAll('.add-question-btn').forEach(button => {
                button.addEventListener('click', function () {
                    addQuestion();
                });
            });
            document.querySelector('#questionsContainer').addEventListener('change', event => {
                if (event.target.classList.contains('mandatory-checkbox')) {
                    const questionForm = event.target.closest('.question-form');
                    if (event.target.checked) {
                    questionForm.setAttribute('data-mandatory', 'true');
                    } else {
                    questionForm.setAttribute('data-mandatory', 'false');
                    }
                }
            });
            document.querySelectorAll('.question-form').forEach(form => {
                initQuestionForm(form);
                if (form.querySelector('.question-type-select').value === 'scale') {
                    bindScaleInputs(form);
                }
            });
            initDragAndDrop();
        });
        function initDragAndDrop() {
            const container = document.getElementById('questionsContainer');
            let draggedElem = null;
            let autoScrollInterval = null;
            let scrollDirection = 0;
            container.querySelectorAll('.question-form-container').forEach(block => {
                block.removeEventListener('dragstart', block._dragStart);
                block.removeEventListener('dragend', block._dragEnd);
                block.removeEventListener('dragover', block._dragOver);
                block.removeEventListener('dragleave', block._dragLeave);
                block.removeEventListener('drop', block._drop);
            });
            container.querySelectorAll('.question-form-container').forEach(block => {
                block._dragStart = function (e) {
                    draggedElem = block;
                    setTimeout(() => block.classList.add('dragging'), 0);
                };
                block._dragEnd = function (e) {
                    block.classList.remove('dragging');
                    document.querySelectorAll('.drag-over').forEach(el=>el.classList.remove('drag-over'));
                    draggedElem = null;
                    stopAutoScroll();
                };
                block._dragOver = function (e) {
                    e.preventDefault();
                    if (block === draggedElem) return;
                    const bounding = block.getBoundingClientRect();
                    const offset = e.clientY - bounding.top;
                    block.classList.add('drag-over');
                    if (offset < bounding.height/2) {
                        block.classList.add('top-indicator');
                        block.classList.remove('bottom-indicator');
                    } else {
                        block.classList.add('bottom-indicator');
                        block.classList.remove('top-indicator');
                    }
                    const edgeZone = 120; 
                    const scrollSpeed = 30; 
                    if (e.clientY < edgeZone) {
                        startAutoScroll(-scrollSpeed);
                    } else if (e.clientY > window.innerHeight - edgeZone) {
                        startAutoScroll(scrollSpeed);
                    } else {
                        stopAutoScroll();
                    }
                };
                block._dragLeave = function(e) {
                    block.classList.remove('drag-over', 'top-indicator', 'bottom-indicator');
                    stopAutoScroll();
                };
                block._drop = function(e) {
                    e.preventDefault();
                    block.classList.remove('drag-over', 'top-indicator', 'bottom-indicator');
                    stopAutoScroll();
                    if (!draggedElem || block === draggedElem) return;
                    const bounding = block.getBoundingClientRect();
                    const offset = e.clientY - bounding.top;
                    if (offset < bounding.height/2) {
                        container.insertBefore(draggedElem, block);
                    } else {
                        if (block.nextSibling) {
                            container.insertBefore(draggedElem, block.nextSibling);
                        } else {
                            container.appendChild(draggedElem);
                        }
                    }
                    renameQuestionFields();
                };
                block.addEventListener('dragstart', block._dragStart);
                block.addEventListener('dragend', block._dragEnd);
                block.addEventListener('dragover', block._dragOver);
                block.addEventListener('dragleave', block._dragLeave);
                block.addEventListener('drop', block._drop);
                block.setAttribute('draggable', 'true');
            });
            document.querySelectorAll('.question-form-container input, .question-form-container select, .question-form-container textarea').forEach(element => {
                element.addEventListener('dragstart', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                });
            });
            function startAutoScroll(direction) {
                if (autoScrollInterval && scrollDirection === direction) return;
                stopAutoScroll(); 
                scrollDirection = direction;
                autoScrollInterval = setInterval(() => {
                    window.scrollBy({top: scrollDirection, left: 0, behavior: 'auto'});
                }, 10); 
            }
            function stopAutoScroll() {
                if (autoScrollInterval) {
                    clearInterval(autoScrollInterval);
                    autoScrollInterval = null;
                    scrollDirection = 0;
                }
            }
        }
        function updateRequiredFields(form) {
            const questionTypeSelect = form.querySelector('.question-type-select');
            const questionOptions = form.querySelector('.question-options');
            const scaleContainer = form.querySelector('.scale-container');
            const isMandatoryCheckbox = form.querySelector('input[type="checkbox"][name^="is_mandatory_"]');
            form.querySelectorAll('input[required], select[required]').forEach(el => {
                el.required = false;
            });
            form.querySelector('input[name^="question_text"]').required = true;
            if (questionTypeSelect.value === 'scale') {
                // Для шкалы
                scaleContainer.querySelectorAll('input[name^="scale_min_"], input[name^="scale_max_"]').forEach(input => {
                    input.required = true;
                });
            } else {
                // Для вариантов ответа
                questionOptions.querySelectorAll('.option-item input[type="text"]').forEach(input => {
                    if (input.value.trim() !== '') {
                        input.required = true;
                    }
                });
            }
            if (isMandatoryCheckbox) {
                isMandatoryCheckbox.required = true;
            }
        }
        
        // Функция для инициализации формы вопроса
        function initQuestionForm(form) {
            const questionTypeSelect = form.querySelector('.question-type-select');
            const questionOptions = form.querySelector('.question-options');
            const scaleContainer = form.querySelector('.scale-container');
            const scaleTypeSelect = form.querySelector('.scale-type-select');
            const scaleInverseCheckbox = form.querySelector('.scale-inverse-checkbox');
            if (scaleInverseCheckbox) {
                scaleInverseCheckbox.checked = scaleInverseCheckbox.hasAttribute('checked') || 
                                            scaleInverseCheckbox.checked;
            }
            function initQuestionType() {
                if (questionTypeSelect.value === 'scale') {
                    questionOptions.style.display = 'none';
                    scaleContainer.style.display = 'flex';
                    if (scaleTypeSelect) {
                        scaleTypeSelect.disabled = false;
                    }
                    bindScaleInputs(form);
                } else {
                    questionOptions.style.display = 'block';
                    scaleContainer.style.display = 'none';
                    if (scaleTypeSelect) {
                        scaleTypeSelect.disabled = true;
                    }
                    if (questionOptions.querySelectorAll('.option-item').length < 1) {
                        addNewOption(form);
                    }
                }
                updateRequiredFields(form);
            }
            questionTypeSelect.addEventListener('change', function () {
                initQuestionType();
            });
            const existingOptions = form.querySelectorAll('.option-item');
            existingOptions.forEach(option => {
                const inputText = option.querySelector('.option-text');
                if (inputText) {
                    inputText.addEventListener('input', function () {
                        toggleRemoveButton(option);
                    });
                }
                const removeBtn = option.querySelector('.remove-option');
                if (removeBtn) {
                    removeBtn.addEventListener('click', function (e) {
                        e.stopPropagation();
                        option.remove();
                    });
                }
            });
            bindScaleInputs(form);
            initQuestionType(); 
        }

        // Функция для управления видимостью кнопки удаления
        function toggleRemoveButton(optionElement) {
            const textInput = optionElement.querySelector('.option-text');
            const removeBtn = optionElement.querySelector('.remove-option');
            removeBtn.style.display = textInput.value.trim() === '' ? 'none' : 'block';
        }

        function toggleLimitTime() {
            const limitedRadio = document.querySelector('input[name="timeLimit"][value="limited"]');
            const timeInputs = document.querySelector('.time-inputs');
            const timeNumberInput = timeInputs.querySelector('input[name="time"]');
            if (limitedRadio.checked) {
                timeInputs.style.display = 'block';
                timeNumberInput.required = true;
            } else {
                timeInputs.style.display = 'none';
                timeNumberInput.required = false;
                timeNumberInput.value = '';
            }
        }
        document.addEventListener('DOMContentLoaded', toggleLimitTime);
        function renameQuestionFields() {
            const questionContainers = document.querySelectorAll('.question-form-container');
            questionContainers.forEach((qContainer, qIndex) => {
                const questionInput = qContainer.querySelector('input[name^="question_text"]');
                if (questionInput) questionInput.setAttribute('name', `question_text_${qIndex}`);
                const typeSelect = qContainer.querySelector('select[name^="question_type"]');
                if (typeSelect) typeSelect.setAttribute('name', `question_type_${qIndex}`);
                const hiddenId = qContainer.querySelector('input[type="hidden"][name^="question_id"]');
                if (hiddenId) hiddenId.setAttribute('name', `question_id_${qIndex}`);
                const isMandatoryCheckbox = qContainer.querySelector('input[type="checkbox"][name^="is_mandatory_"]');
                if (isMandatoryCheckbox) isMandatoryCheckbox.setAttribute('name', `is_mandatory_${qIndex}`);
                const optionItems = qContainer.querySelectorAll('.option-item');
                optionItems.forEach((optionItem, oIndex) => {
                    const choiceInput = optionItem.querySelector('input[type="text"]');
                    if (choiceInput) choiceInput.setAttribute('name', `choice_text_${qIndex}_${oIndex}`);

                    const scoreInput = optionItem.querySelector('input[type="number"]');
                    if (scoreInput) scoreInput.setAttribute('name', `score_${qIndex}_${oIndex}`);
                });
                const scaleMinSign = qContainer.querySelector('input[name^="scale_min_sign"]');
                if (scaleMinSign) scaleMinSign.setAttribute('name', `scale_min_sign_${qIndex}`);
                const scaleMaxSign = qContainer.querySelector('input[name^="scale_max_sign"]');
                if (scaleMaxSign) scaleMaxSign.setAttribute('name', `scale_max_sign_${qIndex}`);
                const scaleMinScore = qContainer.querySelector('input[name^="scale_min_score"]');
                if (scaleMinScore) scaleMinScore.setAttribute('name', `scale_min_score_${qIndex}`);
                const scaleMaxScore = qContainer.querySelector('input[name^="scale_max_score"]');
                if (scaleMaxScore) scaleMaxScore.setAttribute('name', `scale_max_score_${qIndex}`);
                const scaleInverseCB = qContainer.querySelector('.scale-inverse-checkbox');
                if (scaleInverseCB) {
                    const isChecked = scaleInverseCB.checked;
                    scaleInverseCB.setAttribute('name', `scale_inverse_${qIndex}`);
                    scaleInverseCB.checked = isChecked;
                }
                const scaleTypeSelect = qContainer.querySelector('.scale-type-select');
                if (scaleTypeSelect) scaleTypeSelect.setAttribute('name', `scale_type_${qIndex}`);
            });
            updateQuestionNumbers();
        }
    </script>
{% endblock %}